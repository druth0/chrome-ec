/* Copyright 2025 The ChromiumOS Authors
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file.
 */
/* Tune the MP2964 IMVP9.1 parameters for yaviks */
#include "ap_power/ap_power.h"
#include "charger.h"
#include "common.h"
#include "driver/mp2964.h"
#include "hooks.h"
#include "i2c.h"

#include <zephyr/init.h>
#include <zephyr/logging/log.h>

LOG_MODULE_DECLARE(mp2964, CONFIG_LOG_DEFAULT_LEVEL);

const static struct mp2964_reg_val rail_a[] = {
	{ 0x00, 0x0000 }, { 0x01, 0x0080 }, { 0x07, 0x0000 }, { 0x0a, 0x0000 },
	{ 0x0b, 0x0000 }, { 0x1a, 0x0c00 }, { 0x1b, 0x0065 }, { 0x1d, 0x6090 },
	{ 0x1e, 0x0000 }, { 0x1f, 0x4000 }, { 0x21, 0x0083 }, { 0x22, 0x00f0 },
	{ 0x23, 0x0000 }, { 0x24, 0x00ff }, { 0x25, 0x00ff }, { 0x26, 0x0000 },
	{ 0x27, 0x0000 }, { 0x28, 0x000c }, { 0x29, 0x0001 }, { 0x2a, 0x0000 },
	{ 0x2b, 0x0393 }, { 0x2c, 0x0320 }, { 0x2d, 0x000a }, { 0x2e, 0x0fc5 },
	{ 0x2f, 0xa1ef }, { 0x30, 0x243b }, { 0x31, 0x0157 }, { 0x32, 0x15fa },
	{ 0x33, 0xff15 }, { 0x34, 0x7f5d }, { 0x35, 0x002c }, { 0x36, 0x0028 },
	{ 0x37, 0x028a }, { 0x38, 0x0035 }, { 0x39, 0xe8f8 }, { 0x3a, 0x003c },
	{ 0x3b, 0x0064 }, { 0x3c, 0x00d1 }, { 0x3d, 0x29c3 }, { 0x3e, 0x130f },
	{ 0x3f, 0xe081 }, { 0x40, 0x034d }, { 0x41, 0x0153 }, { 0x42, 0x014d },
	{ 0x43, 0x001e }, { 0x44, 0x0053 }, { 0x45, 0x0053 }, { 0x46, 0x00d0 },
	{ 0x47, 0x0003 }, { 0x48, 0x0095 }, { 0x49, 0x0000 }, { 0x4a, 0x1734 },
	{ 0x4b, 0x0b15 }, { 0x4c, 0x01c3 }, { 0x4d, 0xe13f }, { 0x4e, 0x0002 },
	{ 0x4f, 0x0020 }, { 0x50, 0x0000 }, { 0x52, 0x0030 }, { 0x53, 0x0025 },
	{ 0x54, 0xf680 }, { 0x55, 0x002c }, { 0x60, 0x32b0 }, { 0x61, 0x0059 },
	{ 0x62, 0x0cb2 }, { 0x90, 0xeebc }, { 0x91, 0x717d }, { 0x92, 0x2564 },
	{ 0x93, 0x017d }, { 0x94, 0x0002 }, { 0x95, 0x497a }, { 0x96, 0x300a },
	{ 0x97, 0x0181 }, { 0x98, 0x0081 }, { 0x99, 0x0002 }, { 0xa0, 0x0005 },
	{ 0xa1, 0x0014 }, { 0xa2, 0x0285 }, { 0xa3, 0x000a }, { 0xb0, 0x1926 },
	{ 0xb1, 0x14aa }, { 0xb2, 0x0005 }, { 0xb3, 0x20a0 }, { 0xbb, 0x0020 },
	{ 0xbc, 0x0069 }, { 0xbd, 0x001b }, { 0xc0, 0x00a0 }, { 0xc1, 0x2a98 },
	{ 0xc2, 0x4b1e }, { 0xd2, 0x00d0 }, { 0xd3, 0x0003 }, { 0xd4, 0x0063 },
	{ 0xd5, 0x0006 }, { 0xd6, 0x003f }, { 0xd7, 0x000c }, { 0xd8, 0x002d },
	{ 0xd9, 0x0012 }, { 0xda, 0x0000 }, { 0xdb, 0x0000 }, { 0xdc, 0x0000 },
	{ 0xdd, 0x0000 }, { 0xde, 0x0000 }, { 0xdf, 0x0000 }, { 0xe0, 0x0012 },
	{ 0xe1, 0x0006 }, { 0xe2, 0x00d0 }, { 0xe3, 0x0005 }, { 0xe4, 0x0000 },
	{ 0xe5, 0x0000 }, { 0xe6, 0x0000 }, { 0xe7, 0x0000 }, { 0xe8, 0x02b7 },
	{ 0xe9, 0x00b7 }, { 0xea, 0x00b7 }, { 0xeb, 0x00b7 }, { 0xec, 0x0000 },
	{ 0xed, 0x0000 }, { 0xee, 0x0000 }, { 0xef, 0x00c7 }, { 0xf0, 0x02c7 },
	{ 0xf1, 0xc40a }, { 0xf2, 0x00cd }, { 0xf3, 0x0162 }, { 0xf4, 0x0080 },
	{ 0xf5, 0x0aa0 }, { 0xf6, 0x0002 },
};
const static struct mp2964_reg_val rail_b[] = {
	{ 0x00, 0x0001 }, { 0x01, 0x0080 }, { 0x1b, 0x0065 }, { 0x1f, 0x4000 },
	{ 0x21, 0x0083 }, { 0x22, 0x0001 }, { 0x23, 0x0000 }, { 0x24, 0x00ff },
	{ 0x25, 0x00ff }, { 0x26, 0x0000 }, { 0x27, 0x0000 }, { 0x28, 0x000c },
	{ 0x29, 0x0001 }, { 0x2b, 0x0393 }, { 0x2c, 0x02f8 }, { 0x2e, 0x0fc5 },
	{ 0x30, 0x243b }, { 0x31, 0x0157 }, { 0x32, 0x15fa }, { 0x33, 0xff15 },
	{ 0x34, 0x005d }, { 0x37, 0x028a }, { 0x38, 0x002d }, { 0x39, 0xe8f8 },
	{ 0x3a, 0x003c }, { 0x3b, 0x0064 }, { 0x3c, 0x00d1 }, { 0x3d, 0x29c3 },
	{ 0x3e, 0x000f }, { 0x3f, 0xe081 }, { 0x40, 0x034d }, { 0x41, 0x0153 },
	{ 0x42, 0x014d }, { 0x43, 0x001e }, { 0x44, 0x0053 }, { 0x45, 0x0053 },
	{ 0x46, 0x00d0 }, { 0x47, 0x0003 }, { 0x48, 0x0040 }, { 0x49, 0x0000 },
	{ 0x4a, 0x0734 }, { 0x4b, 0x0b15 }, { 0x4c, 0x01c3 }, { 0x4d, 0xe0f9 },
	{ 0x4e, 0x0003 }, { 0x4f, 0x0020 }, { 0x52, 0x0001 }, { 0x53, 0x001d },
	{ 0x54, 0xf680 }, { 0x55, 0x002c }, { 0x60, 0x28b0 }, { 0x61, 0x0059 },
	{ 0x62, 0x0ca8 }, { 0x95, 0x497a }, { 0x96, 0x300a }, { 0x97, 0x0181 },
	{ 0xa3, 0x000a }, { 0xb0, 0x18a6 },
};

static void mp2964_pre_init(struct ap_power_ev_callback *cb,
			    struct ap_power_ev_data data)
{
	int status;

	/* Only run this once */
	ap_power_ev_remove_callback(cb);

	LOG_DBG("attempting to tune PMIC");

	status = mp2964_tune(rail_a, ARRAY_SIZE(rail_a), rail_b,
			     ARRAY_SIZE(rail_b));

	LOG_DBG("PMIC update done with all cell setting");

	if (status != EC_SUCCESS) {
		LOG_ERR("could not update all settings");
	}
}

static int mp2964_init(void)
{
	static struct ap_power_ev_callback cb;

	ap_power_ev_init_callback(&cb, mp2964_pre_init, AP_POWER_STARTUP);
	ap_power_ev_add_callback(&cb);
	return 0;
}
SYS_INIT(mp2964_init, APPLICATION, 1);
